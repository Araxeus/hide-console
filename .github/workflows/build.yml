name: CI

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]

jobs:
  build:
    name: Build (${{ matrix.arch }})
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      - name: Build
        run: build.bat
        shell: cmd

      - name: Run tests
        run: test.bat
        shell: cmd

      - name: Rename artifact
        run: |
          if "${{ matrix.arch }}"=="x64" (
            rem x64 is the default, keep simple name
          ) else (
            move hide.exe hide-${{ matrix.arch }}.exe
          )
        shell: cmd

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: hide-console-${{ matrix.arch }}
          path: ${{ matrix.arch == 'x64' && 'hide.exe' || format('hide-{0}.exe', matrix.arch) }}
          if-no-files-found: error

  attest:
    name: Attest Build Provenance
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      id-token: write
      contents: read
      attestations: write

    steps:
      - name: Download x64 artifact
        uses: actions/download-artifact@v7
        with:
          name: hide-console-x64

      - name: Download x86 artifact
        uses: actions/download-artifact@v7
        with:
          name: hide-console-x86

      - name: Attest x64 build
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: hide.exe

      - name: Attest x86 build
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: hide-x86.exe

  release:
    name: Create Release
    needs: [build, attest]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download x64 artifact
        uses: actions/download-artifact@v7
        with:
          name: hide-console-x64

      - name: Download x86 artifact
        uses: actions/download-artifact@v7
        with:
          name: hide-console-x86

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]' | sed -n '2p')
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Get job ID
        id: job_id
        run: |
          JOB_ID=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            "${{ github.api_url }}/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs" \
            | jq -r '.jobs[] | select(.name == "Create Release") | .id')
          echo "id=$JOB_ID" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          PREV_TAG="${{ steps.prev_tag.outputs.tag }}"
          CURRENT_TAG="${{ github.ref_name }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          RUN_URL="${REPO_URL}/actions/runs/${{ github.run_id }}/job/${{ steps.job_id.outputs.id }}"

          echo "## What's Changed" > release_notes.md
          echo "" >> release_notes.md

          git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"* %s in ${REPO_URL}/commit/%H" --reverse >> release_notes.md

          echo "" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Full Changelog**: ${REPO_URL}/compare/${PREV_TAG}...${CURRENT_TAG}" >> release_notes.md
          echo "" >> release_notes.md
          echo "> *built using githubs actions ([logs](${RUN_URL})) - see [Attestations](${REPO_URL}/attestations) and  [README#security--verification](${REPO_URL}#security--verification)*" >> release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            hide.exe
            hide-x86.exe
          body_path: release_notes.md
          draft: false
          prerelease: false
